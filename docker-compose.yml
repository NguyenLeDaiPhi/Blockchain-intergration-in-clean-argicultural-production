networks:
  bicap-global-net:
    driver: bridge

services:
  auth-db:
    image: mysql:8.0
    container_name: auth-db
    environment:
      - MYSQL_ROOT_PASSWORD=0862264719Phi
      - MYSQL_DATABASE=auth_db
    ports:
      - "3307:3306"
    networks:
      - bicap-global-net
    volumes:
      - ./database/auth-database/bicap_auth_db_roles.sql:/docker-entrypoint-initdb.d/01_roles.sql
      - ./database/auth-database/bicap_auth_db_users.sql:/docker-entrypoint-initdb.d/02_users.sql
      - ./database/auth-database/bicap_auth_db_user_roles.sql:/docker-entrypoint-initdb.d/03_user_roles.sql
      - ./database/auth-database/bicap_auth_db_user_profiles.sql:/docker-entrypoint-initdb.d/04_user_profiles.sql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  bicap-message-queue:
    image: rabbitmq:3-management
    container_name: bicap-message-queue
    environment:
      - RABBITMQ_DEFAULT_USER=root
      - RABBITMQ_DEFAULT_PASS=0862264719Phi
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - bicap-global-net

  auth-service:
    build:
      context: ./services/auth-service
    container_name: auth-service
    depends_on:
      auth-db:
        condition: service_healthy
      bicap-message-queue:
        condition: service_started
    environment:
      - spring.datasource.url=jdbc:mysql://auth-db:3306/auth_db
      - spring.datasource.username=root
      - spring.datasource.password=0862264719Phi
      - spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
      - SPRING_RABBITMQ_HOST=bicap-message-queue
      - SPRING_RABBITMQ_USERNAME=root
      - SPRING_RABBITMQ_PASSWORD=0862264719Phi
    ports:
      - "8080:8080"
    networks:
      - bicap-global-net

  farm-db:
    image: mysql:8.0
    container_name: farm-db
    environment:
      - MYSQL_ROOT_PASSWORD=0862264719Phi
      - MYSQL_DATABASE=bicap_farm_db
    ports:
      - "3308:3306"
    networks:
      - bicap-global-net
    volumes:
      - ./database/farm-production-database/farm-management.sql:/docker-entrypoint-initdb.d/farm-management.sql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  farm-production-service:
    build:
      context: ./services/farm-production-service
    container_name: farm-production-service
    depends_on:
      farm-db:
        condition: service_healthy
      bicap-message-queue:
        condition: service_started
    environment:
      - spring.datasource.url=jdbc:mysql://farm-db:3306/bicap_farm_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - spring.datasource.username=root
      - spring.datasource.password=0862264719Phi
      - spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
      - SPRING_RABBITMQ_HOST=bicap-message-queue
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=root
      - SPRING_RABBITMQ_PASSWORD=0862264719Phi
    ports:
      - "8081:8081"
    networks:
      - bicap-global-net

  blockchain-db:
    image: mysql:8.0
    container_name: blockchain-db
    environment:
      - MYSQL_ROOT_PASSWORD=0862264719Phi
      - MYSQL_DATABASE=bicap_blockchain_db
    ports:
      - "3309:3306"
    networks:
      - bicap-global-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  blockchain-adapter-service:
    build:
      context: ./services/blockchain-adapter-service
    container_name: blockchain-adapter-service
    depends_on:
      blockchain-db:
        condition: service_healthy
      bicap-message-queue:
        condition: service_started
    environment:
      - spring.datasource.url=jdbc:mysql://blockchain-db:3306/bicap_blockchain_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - spring.datasource.username=root
      - spring.datasource.password=0862264719Phi
      - spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
      - SPRING_RABBITMQ_HOST=bicap-message-queue
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=root
      - SPRING_RABBITMQ_PASSWORD=0862264719Phi
    ports:
      - "8082:8082"
    networks:
      - bicap-global-net

  admin-service:
    build:
      context: ./services/admin_service
    container_name: admin-service
    depends_on:
      auth-db:
        condition: service_healthy
      bicap-message-queue:
        condition: service_started
      farm-production-service:
        condition: service_started
    environment:
      - spring.datasource.url=jdbc:mysql://auth-db:3306/auth_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - spring.datasource.username=root
      - spring.datasource.password=0862264719Phi
      - spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
      - SPRING_RABBITMQ_HOST=bicap-message-queue
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=root
      - SPRING_RABBITMQ_PASSWORD=0862264719Phi
      - farm.service.url=http://farm-production-service:8081
    ports:
      - "8085:8085"
    networks:
      - bicap-global-net

  retailer-web:
    build:
      context: ./clients/web-app/retailer-web
    container_name: retailer-web
    depends_on:
      - kong-gateway
    environment:
      - AUTH_SERVICE_URL=http://kong-gateway:8000/api/auth
    ports:
      - "3004:3004"
    networks:
      - bicap-global-net

  admin-web:
    build:
      context: ./clients/web-app/admin-web
    container_name: admin-web
    depends_on:
      - kong-gateway
      - admin-service
      - farm-production-service
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8080
      - ADMIN_SERVICE_URL=http://admin-service:8085
      - FARM_SERVICE_URL=http://farm-production-service:8081
    ports:
      - "3001:3001"
    networks:
      - bicap-global-net
    
  farm-management-web: 
    build:
      context: ./clients/web-app/farm-management-web
    container_name: farm-management-web
    depends_on:
      - kong-gateway
      - bicap-message-queue
    environment:
      - AUTH_SERVICE_URL=http://kong-gateway:8000/api/auth
      - RABBITMQ_URL=amqp://root:0862264719Phi@bicap-message-queue:5672
    ports:
      - "3002:3002"
    networks:
      - bicap-global-net

  shipping-manager-web:
    build: 
      context: ./clients/web-app/shipping-manager-web
    container_name: shipping-manager-web
    depends_on:
      - kong-gateway
    environment:
      - AUTH_SERVICE_URL=http://kong-gateway:8000/api/auth
    ports:
      - "3003:3003"
    networks:
      - bicap-global-net 

  kong-gateway:
    image: kong:latest
    container_name: kong-gateway
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_LOG_LEVEL=debug  
    ports:
      - "8000:8000"
      - "8001:8001"
    networks:
      - bicap-global-net
    volumes:
      - ./api-gateway/kong.yml:/usr/local/kong/declarative/kong.yml
