<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <title>Season Monitor - Quản lý mùa vụ</title>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link href="/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link id="pagestyle" href="/assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <script>
    window.CONFIG = {
      API_GATEWAY_BASE_URL: "<%= API_GATEWAY_BASE_URL %>",
      PRODUCTION_BATCH_API_URL: "<%= PRODUCTION_BATCH_API_URL %>",
      FARMING_PROCESS_API_URL: "<%= FARMING_PROCESS_API_URL %>",
      EXPORT_BATCH_API_URL: "<%= EXPORT_BATCH_API_URL %>"
    };
  </script>
</head>

<body class="g-sidenav-show bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href="/dashboard">
        <img src="/assets/img/logo-ct-dark.png" class="navbar-brand-img" width="26" height="26" alt="main_logo">
        <span class="ms-1 text-sm text-dark">BiCap Farm</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
        <ul class="navbar-nav">
            <li class="nav-item">
            <a class="nav-link text-dark" href="/dashboard">
                <i class="material-symbols-rounded opacity-5">dashboard</i>
                <span class="nav-link-text ms-1">Dashboard</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link active bg-gradient-success text-white" href="/season-monitor">
                <i class="material-symbols-rounded opacity-5">grass</i>
                <span class="nav-link-text ms-1">Season Monitor</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="/products">
                <i class="material-symbols-rounded opacity-5">storefront</i>
                <span class="nav-link-text ms-1">Product Management</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="/shipping">
                <i class="material-symbols-rounded opacity-5">local_shipping</i>
                <span class="nav-link-text ms-1">Shipping</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="/farm-info">
                <i class="material-symbols-rounded opacity-5">agriculture</i>
                <span class="nav-link-text ms-1">Farm Information</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="/notifications">
                <i class="material-symbols-rounded opacity-5">notifications</i>
                <span class="nav-link-text ms-1">Notifications</span>
            </a>
            </li>
            <li class="nav-item mt-3">
            <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Account</h6>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="/profile">
                <i class="material-symbols-rounded opacity-5">person</i>
                <span class="nav-link-text ms-1">Profile</span>
            </a>
            </li>
            <li class="nav-item">
            <a class="nav-link text-dark" href="javascript:void(0);" id="logout-button">
                <div class="d-flex align-items-center">
                <i class="material-symbols-rounded opacity-5">login</i>
                <span class="nav-link-text ms-1">Logout</span>
                </div>
            </a>
            </li>
        </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Season Monitor</li>
          </ol>
        </nav>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
              <div class="bg-gradient-success shadow-success border-radius-lg pt-4 pb-3">
                <h6 class="text-white text-capitalize ps-3">Quản lý mùa vụ</h6>
              </div>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="px-4 pt-2">
                <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createSeasonModal">
                  <i class="material-symbols-rounded">add</i> Tạo mùa vụ mới
                </button>
                
                <% if (error) { %>
                  <div class="alert alert-danger" role="alert">
                    <%= error %>
                  </div>
                <% } %>

                <div id="seasonsList">
                  <% if (seasons && seasons.length > 0) { %>
                    <div class="table-responsive">
                      <table class="table align-items-center mb-0">
                        <thead>
                          <tr>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Mã mùa vụ</th>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Loại sản phẩm</th>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Ngày bắt đầu</th>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Ngày kết thúc</th>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Trạng thái</th>
                            <th class="text-secondary opacity-7">Thao tác</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% seasons.forEach(function(season) { %>
                            <tr>
                              <td>
                                <p class="text-xs font-weight-bold mb-0"><%= season.batchCode || 'N/A' %></p>
                              </td>
                              <td>
                                <p class="text-xs mb-0"><%= season.productType || 'N/A' %></p>
                              </td>
                              <td>
                                <p class="text-xs mb-0"><%= season.startDate || 'N/A' %></p>
                              </td>
                              <td>
                                <p class="text-xs mb-0"><%= season.endDate || 'N/A' %></p>
                              </td>
                              <td>
                                <span class="badge badge-sm bg-gradient-<%= season.status === 'SYNCED' ? 'success' : season.status === 'PENDING_BLOCKCHAIN' ? 'warning' : 'secondary' %>">
                                  <%= season.status || 'N/A' %>
                                </span>
                              </td>
                              <td class="align-middle">
                                <button class="btn btn-sm btn-info me-1" onclick="viewSeasonDetail(<%= season.id %>)">
                                  <i class="material-symbols-rounded" style="font-size: 16px;">visibility</i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="updateProgress(<%= season.id %>)">
                                  <i class="material-symbols-rounded" style="font-size: 16px;">edit</i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="exportSeason(<%= season.id %>)">
                                  <i class="material-symbols-rounded" style="font-size: 16px;">download</i>
                                </button>
                              </td>
                            </tr>
                          <% }); %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <div class="alert alert-info">
                      <p class="mb-0">Chưa có mùa vụ nào. Hãy tạo mùa vụ mới để bắt đầu!</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Tạo mùa vụ mới -->
  <div class="modal fade" id="createSeasonModal" tabindex="-1" aria-labelledby="createSeasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createSeasonModalLabel">Tạo mùa vụ mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createSeasonForm">
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Mã mùa vụ *</label>
              <input type="text" class="form-control" name="batchCode" required>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Loại sản phẩm *</label>
              <input type="text" class="form-control" name="productType" required>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Ngày bắt đầu *</label>
              <input type="date" class="form-control" name="startDate" required>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Ngày kết thúc dự kiến</label>
              <input type="date" class="form-control" name="endDate">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-success" onclick="createSeason()">Tạo mùa vụ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Chi tiết mùa vụ -->
  <div class="modal fade" id="seasonDetailModal" tabindex="-1" aria-labelledby="seasonDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="seasonDetailModalLabel">Chi tiết mùa vụ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="seasonDetailContent">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Cập nhật tiến trình -->
  <div class="modal fade" id="updateProgressModal" tabindex="-1" aria-labelledby="updateProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateProgressModalLabel">Cập nhật tiến trình</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateProgressForm">
            <input type="hidden" id="progressBatchId" name="batchId">
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Loại hoạt động *</label>
              <select class="form-control" name="processType" required>
                <option value="SOWING">Gieo trồng</option>
                <option value="WATERING">Tưới nước</option>
                <option value="FERTILIZING">Bón phân</option>
                <option value="PEST_CONTROL">Phòng trừ sâu bệnh</option>
                <option value="HARVESTING">Thu hoạch</option>
                <option value="OTHER">Khác</option>
              </select>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Mô tả *</label>
              <textarea class="form-control" name="description" rows="3" required></textarea>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Ngày thực hiện *</label>
              <input type="datetime-local" class="form-control" name="performedDate" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-warning" onclick="submitProgress()">Cập nhật</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Xuất tiến trình -->
  <div class="modal fade" id="exportSeasonModal" tabindex="-1" aria-labelledby="exportSeasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportSeasonModalLabel">Xuất tiến trình mùa vụ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="exportSeasonForm">
            <input type="hidden" id="exportBatchId" name="batchId">
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Mã xuất hàng *</label>
              <input type="text" class="form-control" name="batchCode" required>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Số lượng *</label>
              <input type="number" step="0.01" class="form-control" name="quantity" required>
            </div>
            <div class="input-group input-group-outline my-3">
              <label class="form-label">Đơn vị *</label>
              <select class="form-control" name="unit" required>
                <option value="kg">Kilogram (kg)</option>
                <option value="ton">Tấn</option>
                <option value="box">Hộp</option>
                <option value="bag">Bao</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="submitExport()">Xuất hàng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Hiển thị QR Code -->
  <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrCodeModalLabel">QR Code xuất hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div id="qrCodeImage"></div>
          <p class="mt-3">Quét mã QR để truy xuất nguồn gốc sản phẩm</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/assets/js/core/popper.min.js"></script>
  <script src="/assets/js/core/bootstrap.min.js"></script>
  <script src="/assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="/assets/js/material-dashboard.min.js?v=3.2.0"></script>

  <script>
    // Sử dụng các proxy routes từ backend thay vì gọi trực tiếp API
    const API_BASE = window.CONFIG.API_GATEWAY_BASE_URL || 'http://localhost:8000';

    function getAuthToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'auth_token') {
          return value;
        }
      }
      return null;
    }

    async function createSeason() {
      const form = document.getElementById('createSeasonForm');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch('/api/season-monitor/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include', // Quan trọng: gửi cookie
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Tạo mùa vụ thành công!');
          location.reload();
        } else {
          const error = await response.json();
          alert('Lỗi: ' + (error.error || 'Không thể tạo mùa vụ'));
        }
      } catch (error) {
        alert('Lỗi: ' + error.message);
      }
    }

    async function viewSeasonDetail(seasonId) {
      const modal = new bootstrap.Modal(document.getElementById('seasonDetailModal'));
      const content = document.getElementById('seasonDetailContent');
      content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Đang tải...</p></div>';

      try {
        // Backend sử dụng cookie (requireAuth middleware), không cần Authorization header
        const response = await fetch(`/api/season-monitor/${seasonId}/detail`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include' // Quan trọng: gửi cookie
        });

        if (response.ok) {
          const data = await response.json();
          let html = `
            <h6>Thông tin mùa vụ</h6>
            <p><strong>Mã mùa vụ:</strong> ${data.productionBatch?.batchCode || 'N/A'}</p>
            <p><strong>Loại sản phẩm:</strong> ${data.productionBatch?.productType || 'N/A'}</p>
            <p><strong>Ngày bắt đầu:</strong> ${data.productionBatch?.startDate || 'N/A'}</p>
            <p><strong>Ngày kết thúc:</strong> ${data.productionBatch?.endDate || 'N/A'}</p>
            <p><strong>Trạng thái:</strong> ${data.productionBatch?.status || 'N/A'}</p>
            <hr>
            <h6>Tiến trình canh tác (${data.farmingProcesses?.length || 0} hoạt động)</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Loại</th>
                    <th>Mô tả</th>
                    <th>Ngày thực hiện</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          if (data.farmingProcesses && data.farmingProcesses.length > 0) {
            data.farmingProcesses.forEach(process => {
              html += `
                <tr>
                  <td>${process.processType || 'N/A'}</td>
                  <td>${process.description || 'N/A'}</td>
                  <td>${process.performedDate || 'N/A'}</td>
                  <td><span class="badge badge-sm bg-gradient-${process.status === 'SYNCED' ? 'success' : 'warning'}">${process.status || 'N/A'}</span></td>
                </tr>
              `;
            });
          } else {
            html += '<tr><td colspan="4" class="text-center">Chưa có tiến trình nào</td></tr>';
          }

          html += `
                </tbody>
              </table>
            </div>
            <hr>
            <h6>Lịch sử xuất hàng (${data.exportBatches?.length || 0} đợt)</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Mã xuất</th>
                    <th>Số lượng</th>
                    <th>Ngày xuất</th>
                    <th>QR Code</th>
                  </tr>
                </thead>
                <tbody>
          `;

          if (data.exportBatches && data.exportBatches.length > 0) {
            data.exportBatches.forEach((exportBatch, index) => {
              // Lưu QR code vào data attribute thay vì onclick để tránh lỗi với base64 string dài
              const qrCodeData = exportBatch.qrCodeImage ? 
                exportBatch.qrCodeImage.replace(/"/g, '&quot;') : null;
              html += `
                <tr>
                  <td>${exportBatch.batchCode || 'N/A'}</td>
                  <td>${exportBatch.quantity || 'N/A'} ${exportBatch.unit || ''}</td>
                  <td>${exportBatch.exportDate ? new Date(exportBatch.exportDate).toLocaleDateString('vi-VN') : 'N/A'}</td>
                  <td>
                    ${qrCodeData ? 
                      `<button class="btn btn-sm btn-info" data-qr-code="${qrCodeData}" onclick="showQRCodeFromButton(this)">Xem QR</button>` : 
                      'Chưa có'}
                  </td>
                </tr>
              `;
            });
          } else {
            html += '<tr><td colspan="4" class="text-center">Chưa có đợt xuất hàng nào</td></tr>';
          }

          html += `
                </tbody>
              </table>
            </div>
          `;

          content.innerHTML = html;
        } else {
          let errorMessage = `Không thể tải chi tiết mùa vụ (Status: ${response.status})`;
          try {
            const errorData = await response.json();
            // Try multiple possible error message fields
            errorMessage = errorData.error || 
                           errorData.message || 
                           errorData.errorMessage ||
                           errorMessage;
            console.error('Error response:', response.status, errorData);
          } catch (e) {
            const errorText = await response.text();
            errorMessage = errorText || errorMessage;
            console.error('Error response (text):', response.status, errorText);
          }
          content.innerHTML = `<div class="alert alert-danger"><strong>Lỗi:</strong> ${errorMessage}</div>`;
        }
      } catch (error) {
        content.innerHTML = '<div class="alert alert-danger">Lỗi: ' + error.message + '</div>';
      }

      modal.show();
    }

    function updateProgress(batchId) {
      document.getElementById('progressBatchId').value = batchId;
      const modal = new bootstrap.Modal(document.getElementById('updateProgressModal'));
      modal.show();
    }

    async function submitProgress() {
      const form = document.getElementById('updateProgressForm');
      const formData = new FormData(form);
      const batchId = formData.get('batchId');
      const data = {
        processType: formData.get('processType'),
        description: formData.get('description'),
        performedDate: formData.get('performedDate')
      };

      try {
        // Backend sử dụng cookie (requireAuth middleware), không cần Authorization header
        const response = await fetch(`/api/season-monitor/${batchId}/progress`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include', // Quan trọng: gửi cookie
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Cập nhật tiến trình thành công!');
          bootstrap.Modal.getInstance(document.getElementById('updateProgressModal')).hide();
          location.reload();
        } else {
          const error = await response.json();
          alert('Lỗi: ' + (error.error || 'Không thể cập nhật tiến trình'));
        }
      } catch (error) {
        alert('Lỗi: ' + error.message);
      }
    }

    function exportSeason(batchId) {
      document.getElementById('exportBatchId').value = batchId;
      const modal = new bootstrap.Modal(document.getElementById('exportSeasonModal'));
      modal.show();
    }

    async function submitExport() {
      const form = document.getElementById('exportSeasonForm');
      const formData = new FormData(form);
      const batchId = formData.get('batchId');
      const data = {
        batchCode: formData.get('batchCode'),
        quantity: parseFloat(formData.get('quantity')),
        unit: formData.get('unit')
      };

      try {
        // Backend sử dụng cookie (requireAuth middleware), không cần Authorization header
        const response = await fetch(`/api/season-monitor/${batchId}/export`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include', // Quan trọng: gửi cookie
          body: JSON.stringify(data)
        });

        if (response.ok) {
          const result = await response.json();
          bootstrap.Modal.getInstance(document.getElementById('exportSeasonModal')).hide();
          
          if (result.qrCodeImage) {
            showQRCode(result.qrCodeImage);
          }
          alert('Xuất hàng thành công!');
          location.reload();
        } else {
          const error = await response.json();
          alert('Lỗi: ' + (error.error || 'Không thể xuất hàng'));
        }
      } catch (error) {
        alert('Lỗi: ' + error.message);
      }
    }

    function showQRCode(qrCodeImage) {
      const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
      document.getElementById('qrCodeImage').innerHTML = `<img src="${qrCodeImage}" alt="QR Code" class="img-fluid" style="max-width: 300px;">`;
      modal.show();
    }

    // Helper function để lấy QR code từ data attribute
    function showQRCodeFromButton(button) {
      const qrCodeImage = button.getAttribute('data-qr-code');
      if (qrCodeImage) {
        showQRCode(qrCodeImage);
      } else {
        alert('Không tìm thấy QR Code');
      }
    }

    // Logout handler
    document.getElementById('logout-button')?.addEventListener('click', function() {
      fetch('/logout', { method: 'POST' })
        .then(() => window.location.href = '/login')
        .catch(err => console.error('Logout error:', err));
    });
  </script>
</body>
</html>
